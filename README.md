# Aide for Profiling

A minimalist profiler for PHP. The profiler is embeddable, multi-metric, and framework-agnostic 
It fills the gap between a basic timer and full-blown profilers like [Xdebug](https://xdebug.org/) or [Blackfire](https://www.blackfire.io/).

## Installation

### Composer

~~~
composer require bakame/aide-profiler
~~~

### System Requirements

You need:

- **PHP >= 8.1** but the latest stable version of PHP is recommended

## Usage

Traditionally, you will use `microtime` to quickly profile your snippet.

The `Bakame\Aide\Profiler` package is an utility class that helps you remove
the burden of calculating and setting up your code for profiling.

### Basic usage

```php
use Bakame\Aide\Profiler\Profiler;

$callable = function (int ...$args): int|float => {
    usleep(100)
    
    return array_sum($args);
}; 

$profiler = new Profiler($callable);
$result = $profiler(1, 2, 3);
$result = $profiler(4, 5, 6);
$result // wil be equal to 6;
$profile = $profiler->lastProfile(); // returns the last Profile object from the last call

$profile->executionTime();
$profile->cpuTime(); 
$profile->memoryUsage();
$profile->peakMemoryUsage();
$profile->realMemoryUsage();
$profile->realPeakMemoryUsage();
````

### Using labels

You can label each run if you use `Profiler::runWithLabel` this method does the same as the `__invoke` method but
its first argument is the label you want to associate with the profile.

```php
use Bakame\Aide\Profiler\Profiler;

$callable = function (int ...$args): int|float => {
    usleep(100)
    
    return array_sum($args);
}; 

$profiler = new Profiler($callable);
$profiler(1, 2, 3); // returns 6
$profiler(4, 5, 6); // returns 15
$profile = $profiler->lastProfile(); // returns the last Profile object from the last call
$profiler->runWithLabel('3rd_run', 7, 8, 9); // returns 24

$thirdProfile = $profiler->get('3rd_run'); // will return the Profile associated to the label
$profiler->get('foobar'); //returns null because the `foobar` label does not exist
$profiler->has('foobar'); //return false because the label does not exist
$profiler->label(); //will return all the labels attached to the Profiler
````

### Logging the profiling

The `Profiler` can optionally take a `Psr\LoggerInterface` implementing object to log each steps
of the profiling process.

```php
use Bakame\Aide\Profiler\Profiler;
use Monolog\Logger;
use Monolog\Handler\StreamHandler;

$logger = new Logger('profiler');
$logger->pushHandler(new StreamHandler('php://stdout', Logger::DEBUG));

$profiler = new Profiler(function () {
    usleep(1000);

    return 'end';
}, $logger);

$profiler->runWithLabel('toto');
$profiler->runWithLabel('tata');
```

You will see in your terminal the following output.

```bash 
[2025-06-26T16:26:54.935597+00:00] profiler.INFO: Starting profiling for label: toto [] []
[2025-06-26T16:26:54.937517+00:00] profiler.INFO: Finished profiling for label: toto {"cpu_time":2.1e-5,"memory_usage":2536.0,"real_memory_usage":0.0,"peak_memory_usage":0.0,"real_peak_memory_usage":0.0} []
[2025-06-26T16:26:54.937570+00:00] profiler.INFO: Starting profiling for label: tata [] []
[2025-06-26T16:26:54.938688+00:00] profiler.INFO: Finished profiling for label: tata {"cpu_time":1.3000000000000001e-5,"memory_usage":2536.0,"real_memory_usage":0.0,"peak_memory_usage":0.0,"real_peak_memory
```

### Cli Rendering

If you have `symfony\console` installed in your application you can generate
a table with a summary of everything profiles generated by the profiler
using the `CliTableRenderer`.

```php
<?php

use Bakame\Aide\Profiler\Profiler;
use Bakame\Aide\Profiler\CliTableRenderer;

$callable = function (int ...$args): int|float => {
    usleep(100)
    
    return array_sum($args);
}; 

$profiler = new Profiler($callable);
$profiler->runWithLabel('first_run', 1, 2);
$profiler->runWithLabel('last_run', 1, 2);
$profiler(1, 2);

$renderer = new CliTableRenderer();
$renderer->render($profiler);
```
the following table will be outputted in your terminal.

```bash
+--------------+--------------+---------------+-------------+---------------+---------------+----------------+
| Label        | CPU Time (s) | Exec Time (s) | Memory (kB) | Real Mem (kB) | Peak Mem (kB) | Real Peak (kB) |
+--------------+--------------+---------------+-------------+---------------+---------------+----------------+
| first_run    | 0.000094     | 0.001270      | 2.5         | 0.0           | 0.0           | 0.0            |
| last_run     | 0.000009     | 0.001259      | 2.5         | 0.0           | 0.0           | 0.0            |
| 2dc8fd3a8c5e | 0.000009     | 0.001260      | 2.5         | 0.0           | 0.0           | 0.0            |
+--------------+--------------+---------------+-------------+---------------+---------------+----------------+
```

## Testing

The library has:

- a [PHPUnit](https://phpunit.de) test suite.
- a coding style compliance test suite using [PHP CS Fixer](https://cs.symfony.com/).
- a code analysis compliance test suite using [PHPStan](https://github.com/phpstan/phpstan).

To run the tests, run the following command from the project folder.

```bash
composer test
```

## Contributing

Contributions are welcome and will be fully credited. Please see [CONTRIBUTING](.github/CONTRIBUTING.md) and [CONDUCT](.github/CODE_OF_CONDUCT.md) for details.

## Security

If you discover any security related issues, please email nyamsprod@gmail.com instead of using the issue tracker.

## Changelog

Please see [CHANGELOG](CHANGELOG.md) for more information on what has changed recently.

## Credits

- [ignace nyamagana butera](https://github.com/nyamsprod)
- [All Contributors](https://github.com/bakame-php/aide/graphs/contributors)